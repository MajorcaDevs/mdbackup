



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="mdbackup documentation">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Actions overview - mdbackup documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#actions" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mdbackup documentation" aria-label="mdbackup documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mdbackup documentation
            </span>
            <span class="md-header-nav__topic">
              
                Actions overview
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/MajorcaDevs/mdbackup/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mdbackup documentation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mdbackup documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/MajorcaDevs/mdbackup/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../quick-start/" title="Quick start" class="md-nav__link">
      Quick start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Actions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Actions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Actions overview
      </label>
    
    <a href="./" title="Actions overview" class="md-nav__link md-nav__link--active">
      Actions overview
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#builtin-actions" class="md-nav__link">
    Builtin actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-actions" class="md-nav__link">
    Implementing actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registring-actions" class="md-nav__link">
    Registring actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_action" class="md-nav__link">
    register_action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action" class="md-nav__link">
    action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unaction" class="md-nav__link">
    unaction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-user-defined-actions" class="md-nav__link">
    Creating user-defined actions
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Builtin actions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Builtin actions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="archive/" title="Archive" class="md-nav__link">
      Archive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="command/" title="Command" class="md-nav__link">
      Command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="compress/" title="Compress" class="md-nav__link">
      Compress
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="database/" title="Database" class="md-nav__link">
      Database
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="directory/" title="Directory" class="md-nav__link">
      Directory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="encrypt/" title="Encrypt" class="md-nav__link">
      Encrypt
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="file/" title="File" class="md-nav__link">
      File
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="network/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tasks/" title="Tasks" class="md-nav__link">
      Tasks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Storage providers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Storage providers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/gdrive/" title="Google Drive" class="md-nav__link">
      Google Drive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/s3/" title="S3" class="md-nav__link">
      S3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/b2/" title="B2" class="md-nav__link">
      B2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/ftp/" title="FTP(S)" class="md-nav__link">
      FTP(S)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../storage/sftp/" title="SFTP" class="md-nav__link">
      SFTP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Secrets providers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Secrets providers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../secrets/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../secrets/file/" title="File" class="md-nav__link">
      File
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../secrets/vault/" title="Vault" class="md-nav__link">
      Vault
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hooks/" title="Hooks" class="md-nav__link">
      Hooks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../arguments/" title="Arguments" class="md-nav__link">
      Arguments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../run-as-service/" title="Run as a service" class="md-nav__link">
      Run as a service
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#builtin-actions" class="md-nav__link">
    Builtin actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-actions" class="md-nav__link">
    Implementing actions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registring-actions" class="md-nav__link">
    Registring actions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_action" class="md-nav__link">
    register_action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action" class="md-nav__link">
    action
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unaction" class="md-nav__link">
    unaction
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-user-defined-actions" class="md-nav__link">
    Creating user-defined actions
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/MajorcaDevs/mdbackup/blob/master/actions/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="actions">Actions<a class="headerlink" href="#actions" title="Permanent link">&para;</a></h1>
<p>An action is a unit of work inside a backup that does one thing. An action can receive data or a folder and/or can produce data or a folder. Depending on the type of input and output, an action can be <em>initial</em>, <em>transformer</em> or <em>final</em>. By combining actions, a backup can be done (that is, a <a href="#">task</a>).</p>
<p>An <strong>initial action</strong> is an action that does not receive anything as input and produces an output. These actions must be the first to appear in the task pipeline.</p>
<p>A <strong>transformer action</strong> is an action that receives something as input and applies some transformation on it to produce a different output. These actions must appear in between the task pipeline.</p>
<p>A <strong>final action</strong> is an action taht receives something as input and do not produce an output (for the pipeline). These actions must appear last in the task pipeline. Note that final actions in general produces a file or a folder in the backup folder.</p>
<div class="admonition info">
<p class="admonition-title">Initial and final actions</p>
<p>An action can be initial and final. For example, copy a file or a folder to the backup folder is both initial and final action. If using these kind of actions can only appear one action in a task pipeline.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Initial or transformer actions</p>
<p>For example, <code class="codehilite"><span class="err">command</span></code>, <code class="codehilite"><span class="err">ssh</span></code> and <code class="codehilite"><span class="err">docker</span></code> actions can be either an initial or transformer actions, it just depends if the command to run needs an input from another source or not. For example the command <code class="codehilite"><span class="err">echo hello world</span></code> don&rsquo;t need an input, but <code class="codehilite"><span class="err">cat</span></code> needs one.</p>
</div>
<p>Not yet mentioned, but <strong>unactions</strong> also exist. Think of <em>unactions</em> as a reversed action. If an action is to compress some data, its <em>unaction</em> will be decompress the data. <em>unactions</em> are like actions in all senses, but the behaviour is to revert an action (in general used in restores).</p>
<h2 id="builtin-actions">Builtin actions<a class="headerlink" href="#builtin-actions" title="Permanent link">&para;</a></h2>
<p>There is a list of builtin actions that can be used to create the tasks pipelines or to create new actions by using these as base actions. The actions are grouped by category. See the list here:</p>
<ul>
<li><a href="./archive">Archive</a></li>
<li><a href="./command">Command</a></li>
<li><a href="./compress">Compress</a></li>
<li><a href="./database">Database</a></li>
<li><a href="./directory">Directory</a></li>
<li><a href="./encrypt">Encrypt</a></li>
<li><a href="./file">File</a></li>
<li><a href="./network">Network</a></li>
</ul>
<h2 id="implementing-actions">Implementing actions<a class="headerlink" href="#implementing-actions" title="Permanent link">&para;</a></h2>
<p>In python, an action (and <em>unaction</em>) is just a function that receives two arguments and returns something. An initial action will receive <code class="codehilite"><span class="err">None</span></code> and the parameters as arguments and should return a data stream or a <code class="codehilite"><span class="err">DirEntry</span></code> iterator. A transformer action will receive a data stream or a <code class="codehilite"><span class="err">DirEntry</span></code> iterator (depending on the expected input) and the parameters as arguments and will return a data stream or a <code class="codehilite"><span class="err">DirEntry</span></code> iterator. A final action will receive a data stream or a <code class="codehilite"><span class="err">DirEntry</span></code> iterator and must return the relative path of the file or folder that the action has created. An action can use another action internally to make a composition of actions.</p>
<div class="admonition info">
<p class="admonition-title"><code class="codehilite"><span class="err">DirEntry</span></code></p>
<p>Is a data structure used internally to represent a entry of a folder. The object is defined like this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">DirEntry</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="n">stats</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat_result</span>
    <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">]</span>
    <span class="n">link_content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">real_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link_content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">real_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>

</div>
<p>In actions, a <strong>data stream</strong> means a <code class="codehilite"><span class="err">io.FileIO</span></code>, <code class="codehilite"><span class="err">io.BufferedIOBase</span></code> or <code class="codehilite"><span class="err">io.TextIOBase</span></code> object that has a file descriptor associated to the stream, or a <code class="codehilite"><span class="err">subprocess.Popen</span></code> object with <code class="codehilite"><span class="err">PIPE</span></code> mode set to <code class="codehilite"><span class="err">stdout</span></code> and <code class="codehilite"><span class="err">stderr</span></code>. Currently, the <em>file descriptor</em>-thing is important because they are used to be used in external processes efficently (without using internal pipes). <code class="codehilite"><span class="err">mdbackup</span></code> checks if a data stream is invalid and raises an error for it.</p>
<p>On the other hand, the <code class="codehilite"><span class="err">DirEntry</span></code> iterator is implemented using a generator function that returns <code class="codehilite"><span class="err">DirEntry</span></code> objects for each entry found in the folder. The type of a entry can be <code class="codehilite"><span class="err">dir</span></code>, <code class="codehilite"><span class="err">symlink</span></code> or <code class="codehilite"><span class="err">file</span></code>. A file will have the <code class="codehilite"><span class="err">stream</span></code> attribute filled pointing to the contents of the file.
A symlink will have the <code class="codehilite"><span class="err">link_content</span></code> attribute set with the contents of the symlink. In all types, the <code class="codehilite"><span class="err">path</span></code> must be filled with a relative path to the entry, as well as <code class="codehilite"><span class="err">stats</span></code>, requiring <code class="codehilite"><span class="err">st_mode</span></code>, <code class="codehilite"><span class="err">st_uid</span></code>, <code class="codehilite"><span class="err">st_gid</span></code>, <code class="codehilite"><span class="err">st_mtime</span></code>, <code class="codehilite"><span class="err">st_size</span></code> properties to be filled.</p>
<details class="example"><summary>Example of initial action</summary><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">action_read_file</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

</details>
<details class="example"><summary>Example of transform action</summary><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">action_compress_gzip</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="n">InputDataStream</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">:</span>
    <span class="n">compression_level</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compressionLevel&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">compression_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-</span><span class="si">{</span><span class="n">compression_level</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Composition of actions: using command action to create the compress-gz action</span>
    <span class="k">return</span> <span class="n">action_command</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">action_example_of_dir_entry</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.bak&#39;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">entry</span>
</code></pre></div>

</details>
<details class="example"><summary>Example of final action</summary><div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">action_write_file</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="n">InputDataStream</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="c1"># The _backup_path parameter is internal, and can be used freely</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;_backup_path&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>

    <span class="n">file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chunkSize&#39;</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">full_path</span>
</code></pre></div>

</details>
<h2 id="registring-actions">Registring actions<a class="headerlink" href="#registring-actions" title="Permanent link">&para;</a></h2>
<p>Using the <code class="codehilite"><span class="err">register_action</span></code> function, an action (and its <em>unaction</em> counterpart) will be registered in the system and could be used in the tasks. There is also a quick way to register actions and <em>unactions</em> which is using the <code class="codehilite"><span class="err">action</span></code> and <code class="codehilite"><span class="err">unaction</span></code> decorators. For user-defined actions, those functions will be received in the function called when registering from a module.</p>
<h3 id="register_action"><code class="codehilite"><span class="err">register_action</span></code><a class="headerlink" href="#register_action" title="Permanent link">&para;</a></h3>
<p>The function registers an action into the actions container in order to be used when running tasks.</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
<th>Optional</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="err">identifier</span></code></td>
<td><code class="codehilite"><span class="err">str</span></code></td>
<td>Defines the identifier to be used to refer the action in the yaml files</td>
<td>No</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">action</span></code></td>
<td><code class="codehilite"><span class="err">callable</span></code></td>
<td>The function that implements the action</td>
<td>No</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">unaction</span></code></td>
<td><code class="codehilite"><span class="err">callable</span></code></td>
<td>The function that implements the <em>unaction</em></td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">expected_input</span></code></td>
<td><code class="codehilite"><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"></span></code></td>
<td>The expected input for the action</td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">output</span></code></td>
<td><code class="codehilite"><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"></span></code></td>
<td>The output for the action</td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
</tbody>
</table>
<p>The supported values for <code class="codehilite"><span class="err">expected_input</span></code> are: <code class="codehilite"><span class="err">stream</span></code> or <code class="codehilite"><span class="err">directory</span></code>.</p>
<p>The supported values for <code class="codehilite"><span class="err">output</span></code> are: <code class="codehilite"><span class="err">stream</span></code> <code class="codehilite"><span class="n">stream</span><span class="o">:</span><span class="n">file</span></code>, <code class="codehilite"><span class="n">stream</span><span class="o">:</span><span class="n">process</span></code>, <code class="codehilite"><span class="n">stream</span><span class="o">:</span><span class="n">pipe</span></code> (only if using <code class="codehilite"><span class="err">os.pipe()</span></code> fds) or <code class="codehilite"><span class="err">directory</span></code>.</p>
<h3 id="action"><code class="codehilite"><span class="err">action</span></code><a class="headerlink" href="#action" title="Permanent link">&para;</a></h3>
<p>Decorator for actions that will register them automatically (once the module that contains the implementation is loaded). Is a shortcut for <code class="codehilite"><span class="err">register_action</span></code> and allows in-place registration of actions.</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
<th>Optional</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="err">identifier</span></code></td>
<td><code class="codehilite"><span class="err">str</span></code></td>
<td>Defines the identifier to be used to refer the action in the yaml files</td>
<td>No</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">input</span></code></td>
<td><code class="codehilite"><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"></span></code></td>
<td>The expected input for the action</td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">output</span></code></td>
<td><code class="codehilite"><span class="n">Optional</span><span class="o">[</span><span class="n">str</span><span class="o">]</span><span class="w"></span></code></td>
<td>The output for the action</td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="err">unaction</span></code></td>
<td><code class="codehilite"><span class="err">callable</span></code></td>
<td>The function that implements the <em>unaction</em> (use it only if <code class="codehilite"><span class="err">@unaction()</span></code> won&rsquo;t be used)</td>
<td>Yes</td>
<td><code class="codehilite"><span class="err">None</span></code></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Parameters</p>
<p><code class="codehilite"><span class="err">input</span></code> is the same as <code class="codehilite"><span class="err">expected_input</span></code> from the <code class="codehilite"><span class="err">register_action</span></code>. All parameters expect the same as in <code class="codehilite"><span class="err">register_action</span></code>.</p>
</div>
<h3 id="unaction"><code class="codehilite"><span class="err">unaction</span></code><a class="headerlink" href="#unaction" title="Permanent link">&para;</a></h3>
<p>Decorator for <em>unactions</em> that will register them automatically (once the module that contains the implementation is loaded). Is a shortcut for <code class="codehilite"><span class="err">register_action</span></code> and allows in-place registration of <em>unactions</em> once its action counterpart is registered.</p>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
<th>Optional</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="err">identifier</span></code></td>
<td><code class="codehilite"><span class="err">str</span></code></td>
<td>Defines the identifier to be used to refer the action in the yaml files</td>
<td>No</td>
<td></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>An <em>unaction</em> can be registered after the action has been registered. If the order is inverted, the <em>unaction</em> register will fail.</p>
</div>
<h2 id="creating-user-defined-actions">Creating user-defined actions<a class="headerlink" href="#creating-user-defined-actions" title="Permanent link">&para;</a></h2>
<p>As mentioned in the <a href="../configuration">configuration</a>, the user-defined actions must be modules that can be loaded from python using the <code class="codehilite"><span class="err">import</span></code> syntax. The value in the configuration was <code class="codehilite"><span class="err">module#function</span></code> where <code class="codehilite"><span class="err">module</span></code> is the module to import and <code class="codehilite"><span class="k">function</span></code> is the name of the callable object that will register all actions.</p>
<p>The function (or callable object) will receive some keyword arguments (aka <code class="codehilite"><span class="err">kwargs</span></code>) with the <code class="codehilite"><span class="err">register_action</span></code> function and <code class="codehilite"><span class="err">action</span></code> and <code class="codehilite"><span class="err">unaction</span></code> decorators to be used quickly without the need to import them. You can also import them directly by importing the module <code class="codehilite"><span class="err">mdbackup.actions.container</span></code>. The function will also receive <code class="codehilite"><span class="err">get_action</span></code> and <code class="codehilite"><span class="err">get_unaction</span></code> that retrieves the implementation for the action/<em>unaction</em> for the given identifier (the first parameter of both functions). And lastly, the <em>kwarg</em> <code class="codehilite"><span class="err">dir_entry</span></code> will be passed with the class <code class="codehilite"><span class="err">DirEntry</span></code> if needed.</p>
<p>The function must register all actions by either using the function or the decorator. If anything fails, your function should raise an exception to notify the failure, and put some <code class="codehilite"><span class="err">debug</span></code> logs will also help.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">register_my_actions</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">unaction</span><span class="p">,</span> <span class="n">get_action</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">action_ssh</span> <span class="o">=</span> <span class="n">get_action</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;my-read-file&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;stream:file&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">action_read_file</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@action</span><span class="p">(</span><span class="s1">&#39;pi-copy&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;stream:process&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">action_pi_copy</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">action_ssh</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;pi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;pi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;raspberrypi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;knownHostsPolicy&#39;</span><span class="p">:</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span>  <span class="c1"># You should never do this</span>
            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;if [[ -f &quot;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; ]]; then cat &quot;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;; else cd &quot;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;; tar -c .; fi&#39;</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../configuration/" title="Configuration" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Configuration
              </span>
            </div>
          </a>
        
        
          <a href="archive/" title="Archive" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Archive
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            MajorcaDevs 2019
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>